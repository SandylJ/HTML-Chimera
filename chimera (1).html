<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Project Chimera - Melvor x Runescape x Cookie Clicker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --border-color: #30363d;
            --text-primary: #c9d1d9;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --font-main: 'Inter', sans-serif;
        }
        body { font-family: var(--font-main); background-color: var(--bg-primary); color: var(--text-primary); }
        .block { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; }
        .sidebar-link { transition: background-color 0.2s ease; }
        .sidebar-link:hover, .sidebar-link.active { background-color: #21262d; }
        .sidebar-link.active { border-right: 3px solid var(--accent-blue); }
        .xp-bar-bg { background-color: #010409; }
        .xp-bar-fill { background-color: var(--accent-blue); transition: width 0.5s ease-out; }
        .mastery-bar-fill { background-color: #ffc107; }
        .stamina-bar-fill { background-color: var(--accent-green); }
        .chimera-button { background-color: #21262d; border: 1px solid var(--border-color); transition: all 0.2s ease; }
.chimera-button:hover { background-color: #30363d; border-color: #8b949e; }
.chimera-button:disabled { background-color: #0d1117; border-color: #21262d; color: var(--text-secondary); cursor: not-allowed; }

/* Spectacular MMO-style flytext */
.floating-text { position: absolute; font-size: 1.125rem; font-weight: 800; letter-spacing: 0.2px; pointer-events: none; z-index: 100; text-shadow: 0 2px 10px rgba(0,0,0,0.6), 0 0 6px rgba(0,0,0,0.35); will-change: transform, opacity; user-select: none; animation: fly-rise 1.6s ease-out forwards; }

/* Type flavors */
.fly-damage { animation: fly-rise 1.4s ease-out forwards, fly-wiggle 1.4s ease-out; filter: drop-shadow(0 0 6px rgba(248,81,73,0.6)); }
.fly-crit { animation: fly-pop 0.2s ease-out, fly-rise 1.6s ease-out 0.05s forwards, fly-wiggle 1.6s ease-out 0.05s; filter: drop-shadow(0 0 8px rgba(255,196,0,0.8)); transform-origin: center; }
.fly-heal { animation: fly-rise 1.6s ease-out forwards, fly-wiggle 1.6s ease-out; filter: drop-shadow(0 0 6px rgba(63,185,80,0.7)); }
.fly-xp { animation: fly-rise 1.6s ease-out forwards, fly-wiggle 1.6s ease-out; filter: drop-shadow(0 0 6px rgba(88,166,255,0.7)); }
.fly-loot { animation: fly-rise 1.8s ease-out forwards, fly-wiggle 1.8s ease-out, fly-shine 1.2s ease-in-out; filter: drop-shadow(0 0 8px rgba(255,214,10,0.6)); }
.fly-level { animation: fly-pop 0.25s ease-out, fly-rise 1.9s ease-out 0.05s forwards, fly-wiggle 1.9s ease-out 0.05s, fly-shine 1.8s ease-in-out; filter: drop-shadow(0 0 10px rgba(63,185,80,0.85)); }

/* Animations */
@keyframes fly-rise {
  0% { opacity: 0; transform: translate(-50%, 8px) scale(0.98); }
  10% { opacity: 1; transform: translate(-50%, 0) scale(1); }
  100% { opacity: 0; transform: translate(-50%, -56px) scale(0.98); }
}
@keyframes fly-pop { 0% { transform: translate(-50%, 0) scale(0.6); } 100% { transform: translate(-50%, 0) scale(1.15); } }
@keyframes fly-wiggle {
  0% { transform: translateX(-50%) translateY(0); }
  50% { transform: translateX(calc(-50% + 6px)) translateY(-24px); }
  100% { transform: translateX(calc(-50% - 4px)) translateY(-48px); }
}
@keyframes fly-shine { 0%, 100% { filter: drop-shadow(0 0 8px rgba(255,255,255,0.1)); } 50% { filter: drop-shadow(0 0 12px rgba(255,255,255,0.7)); } }

.tooltip { position: relative; display: inline-block; }
        .tooltip .tooltiptext { visibility: hidden; width: 220px; background-color: #010409; color: #fff; text-align: left; border-radius: 6px; padding: 8px; position: absolute; z-index: 50; bottom: 125%; left: 50%; margin-left: -110px; opacity: 0; transition: opacity 0.3s; border: 1px solid var(--border-color); font-size: 0.8rem; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .border-woodcutting { border-color: #654321; } .bg-woodcutting { background-color: #654321; }
        .badge { display:inline-flex; align-items:center; gap:6px; background-color:#1f2937; border:1px solid var(--border-color); border-radius:9999px; padding:2px 8px; font-size:11px; }
        .badge i { opacity:0.9; }
        .border-mining { border-color: #808080; } .bg-mining { background-color: #808080; }
        .border-fishing { border-color: #00bfff; } .bg-fishing { background-color: #00bfff; }
        .border-firemaking { border-color: #ff4500; } .bg-firemaking { background-color: #ff4500; }
        .border-smithing { border-color: #a9a9a9; } .bg-smithing { background-color: #a9a9a9; }
        .border-cooking { border-color: #d2691e; } .bg-cooking { background-color: #d2691e; }
        .medieval-border { border-image: linear-gradient(45deg, #8b5a2b, #b8860b) 1; border-width: 1px; border-style: solid; }
        .medieval-glow { box-shadow: 0 0 0 1px rgba(255,215,0,0.08) inset, 0 0 24px rgba(255,215,0,0.06); }
    </style>
</head>
<body class="text-sm">
    <div id="game-container" class="w-full h-screen flex">
        <nav id="sidebar" class="w-64 bg-secondary flex-shrink-0 flex flex-col border-r border-border-color">
            <div class="p-4 text-center border-b border-border-color">
                <h1 class="text-xl font-bold text-white">Project Chimera</h1>
                <p class="text-xs text-secondary">Melvor x Runescape x Cookie Clicker</p>
            </div>
            <div class="flex-grow overflow-y-auto">
                <h2 class="p-2 pt-4 text-xs font-bold tracking-wider uppercase text-secondary">Core</h2>
                <a href="#" class="sidebar-link active flex items-center p-3" data-view="dashboard"><i class="fas fa-tachometer-alt w-6 text-center"></i><span>Dashboard</span></a>
                <a href="#" class="sidebar-link flex items-center p-3" data-view="bank"><i class="fas fa-box w-6 text-center"></i><span>Bank</span></a>
                <a href="#" class="sidebar-link flex items-center p-3" data-view="combat"><i class="fas fa-skull w-6 text-center"></i><span>Combat</span></a>
                <a href="#" class="sidebar-link flex items-center p-3" data-view="clicker"><i class="fas fa-chess-rook w-6 text-center"></i><span>Empire</span></a>
                <a href="#" class="sidebar-link flex items-center p-3" data-view="spellbook"><i class="fas fa-hat-wizard w-6 text-center"></i><span>Spellbook</span></a>
                <a href="#" class="sidebar-link flex items-center p-3" data-view="shop"><i class="fas fa-store w-6 text-center"></i><span>Shop</span></a>
                <h2 class="p-2 pt-4 text-xs font-bold tracking-wider uppercase text-secondary">Gathering</h2>
                <div id="gathering-skills-nav"></div>
                <h2 class="p-2 pt-4 text-xs font-bold tracking-wider uppercase text-secondary">Artisan</h2>
                <div id="artisan-skills-nav"></div>
                <h2 class="p-2 pt-4 text-xs font-bold tracking-wider uppercase text-secondary">Meta</h2>
                <a href="#" class="sidebar-link flex items-center p-3" data-view="meta_skills"><i class="fas fa-star w-6 text-center"></i><span>Meta Skills</span></a>
            </div>
        </nav>
        <div class="flex-grow flex flex-col">
            <header class="flex-shrink-0 p-3 bg-secondary border-b border-border-color grid grid-cols-2 gap-4">
                <div class="flex items-center space-x-4">
                    <div class="flex items-center space-x-2"><i class="fas fa-coins text-yellow-400"></i><span id="gold-display">0</span><span id="gps-display" class="text-xs text-secondary ml-2">(+0/s)</span></div>
                    <div class="flex items-center space-x-2"><i class="fas fa-gem text-purple-300"></i><span id="runes-display" class="font-mono">0</span></div>
                    <div class="flex items-center space-x-2 w-full">
                        <i class="fas fa-bolt text-green-400"></i>
                        <div class="w-full bg-black/50 rounded-full h-5 border border-border-color overflow-hidden"><div id="stamina-bar-fill" class="stamina-bar-fill h-full rounded-full"></div></div>
                        <span id="stamina-value" class="font-mono">0/100</span>
                    </div>
                </div>
                <div id="mastery-progress-bar" class="block"></div>
            </header>
            <main id="main-content" class="flex-grow p-4 overflow-y-auto"></main>
        </div>
    </div>

    <div id="modal-backdrop" class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div id="modal-content" class="block p-6 w-full max-w-md max-h-[90vh] overflow-y-auto"></div>
    </div>
    <div id="floating-text-container" class="absolute inset-0 pointer-events-none"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const META_SKILLS = { STRENGTH: 'Strength', INTELLECT: 'Intellect', STEWARDSHIP: 'Stewardship', RESILIENCE: 'Resilience', ARTISTRY: 'Artistry' };
        const TASK_CATEGORIES = { FITNESS: META_SKILLS.STRENGTH, STUDY: META_SKILLS.INTELLECT, CHORES: META_SKILLS.STEWARDSHIP, SELF_CARE: META_SKILLS.RESILIENCE, CREATIVE: META_SKILLS.ARTISTRY };

        const GAME_DATA = {
            SKILLS: {
                woodcutting: { name: 'Woodcutting', type: 'gathering', icon: 'fa-tree', theme: 'woodcutting' },
                mining: { name: 'Mining', type: 'gathering', icon: 'fa-gem', theme: 'mining' },
                fishing: { name: 'Fishing', type: 'gathering', icon: 'fa-fish', theme: 'fishing' },
                firemaking: { name: 'Firemaking', type: 'artisan', icon: 'fa-fire', theme: 'firemaking' },
                smithing: { name: 'Smithing', type: 'artisan', icon: 'fa-hammer', theme: 'smithing' },
                cooking: { name: 'Cooking', type: 'artisan', icon: 'fa-utensils', theme: 'cooking' },
                runecrafting: { name: 'Runecrafting', type: 'artisan', icon: 'fa-circle-nodes', theme: 'smithing' },
            },
            ITEMS: {
                // Core resources
                logs: { name: 'Logs', icon: 'ðŸªµ' }, oak_logs: { name: 'Oak Logs', icon: 'ðŸªµ' },
                copper_ore: { name: 'Copper Ore', icon: 'ðŸª¨' }, tin_ore: { name: 'Tin Ore', icon: 'ðŸª¨' },
                bronze_bar: { name: 'Bronze Bar', icon: 'ðŸŸ§' }, bronze_dagger: { name: 'Bronze Dagger', icon: 'ðŸ—¡ï¸', damage: 4 },
                raw_shrimp: { name: 'Raw Shrimp', icon: 'ðŸ¦' }, raw_sardine: { name: 'Raw Sardine', icon: 'ðŸŸ' },
                shrimp: { name: 'Shrimp', icon: 'ðŸ¤', heals: 20 }, sardine: { name: 'Sardine', icon: 'ðŸ ', heals: 30 },
                bird_nest: { name: 'Bird Nest', icon: 'ðŸªº' },

                // Shop & chest items mirrored from native dataset
                seed_vigor: { name: 'Seed of Vigor', icon: 'ðŸŒ±' },
                seed_clarity: { name: 'Seed of Clarity', icon: 'ðŸŒ±' },
                seed_inspiration: { name: 'Seed of Inspiration', icon: 'ðŸŒ±' },
                material_joyful_ember: { name: 'Joyful Ember', icon: 'ðŸ”¥' },
                material_sunstone_shard: { name: 'Sunstone Shard', icon: 'ðŸ”¶' },
                material_essence: { name: 'Raw Essence', icon: 'âœ¨' },
                item_ancient_key: { name: 'Ancient Key', icon: 'ðŸ—ï¸' },
                tree_ironwood: { name: 'Ironwood Sapling', icon: 'ðŸŒ³' },

                item_elixir_strength: { name: 'Elixir of Strength', icon: 'ðŸ§ª' },
                item_scroll_fortune: { name: 'Scroll of Fortune', icon: 'ðŸ“œ' },

                // Runecrafting resources and products
                rune_essence: { name: 'Rune Essence', icon: 'âœ¨' },
                air_rune: { name: 'Air Rune', icon: 'ðŸŒ€' },
                mind_rune: { name: 'Mind Rune', icon: 'ðŸ§ ' },
                water_rune: { name: 'Water Rune', icon: 'ðŸ’§' },
                earth_rune: { name: 'Earth Rune', icon: 'ðŸª¨' },
                fire_rune: { name: 'Fire Rune', icon: 'ðŸ”¥' },
                body_rune: { name: 'Body Rune', icon: 'ðŸ‹ï¸' },
                cosmic_rune: { name: 'Cosmic Rune', icon: 'ðŸŒŒ' },
                chaos_rune: { name: 'Chaos Rune', icon: 'â˜„ï¸' },
                nature_rune: { name: 'Nature Rune', icon: 'ðŸƒ' },
                law_rune: { name: 'Law Rune', icon: 'âš–ï¸' },
                death_rune: { name: 'Death Rune', icon: 'ðŸ’€' },
                blood_rune: { name: 'Blood Rune', icon: 'ðŸ©¸' },
            },
            ACTIONS: {
                woodcutting: [
                    { id: 'normal_tree', name: 'Normal Trees', level: 1, xp: 10, output: { itemId: 'logs', quantity: 1 }, baseTime: 3000, rareDrop: { itemId: 'bird_nest', chance: 1 } },
                    { id: 'oak_tree', name: 'Oak Trees', level: 15, xp: 25, output: { itemId: 'oak_logs', quantity: 1 }, baseTime: 5000, rareDrop: { itemId: 'bird_nest', chance: 1.5 } },
                ],
                mining: [
                    { id: 'copper_rock', name: 'Copper Rock', level: 1, xp: 12, output: { itemId: 'copper_ore', quantity: 1 }, baseTime: 3500 },
                    { id: 'tin_rock', name: 'Tin Rock', level: 1, xp: 12, output: { itemId: 'tin_ore', quantity: 1 }, baseTime: 3500 },
                    { id: 'essence_rock', name: 'Rune Essence Rock', level: 1, xp: 6, output: { itemId: 'rune_essence', quantity: 1 }, baseTime: 3000 },
                ],
                fishing: [
                    { id: 'shrimp_spot', name: 'Shrimp Spot', level: 1, xp: 8, output: { itemId: 'raw_shrimp', quantity: 1 }, baseTime: 4000 },
                    { id: 'sardine_spot', name: 'Sardine Spot', level: 5, xp: 15, output: { itemId: 'raw_sardine', quantity: 1 }, baseTime: 4500 },
                ],
            },
            RECIPES: {
                smithing: [
                    { id: 'bronze_bar', name: 'Bronze Bar', level: 1, xp: 15, input: [{ itemId: 'copper_ore', quantity: 1 }, { itemId: 'tin_ore', quantity: 1 }], output: { itemId: 'bronze_bar', quantity: 1 }, baseTime: 4000 },
                    { id: 'bronze_dagger', name: 'Bronze Dagger', level: 5, xp: 25, input: [{ itemId: 'bronze_bar', quantity: 1 }], output: { itemId: 'bronze_dagger', quantity: 1 }, baseTime: 5000 },
                ],
                firemaking: [
                    { id: 'bonfire_logs', name: 'Bonfire (Logs)', level: 1, xp: 20, input: [{ itemId: 'logs', quantity: 10 }], output: {}, baseTime: 20000 },
                ],
                cooking: [
                    { id: 'cook_shrimp', name: 'Cook Shrimp', level: 1, xp: 10, input: [{ itemId: 'raw_shrimp', quantity: 1 }], output: { itemId: 'shrimp', quantity: 1 }, baseTime: 3000 },
                    { id: 'cook_sardine', name: 'Cook Sardine', level: 5, xp: 18, input: [{ itemId: 'raw_sardine', quantity: 1 }], output: { itemId: 'sardine', quantity: 1 }, baseTime: 3500 },
                ],
                runecrafting: [
                    { id: 'air_rune', name: 'Air Altar (Air Rune)', level: 1, xp: 5, input: [{ itemId: 'rune_essence', quantity: 1 }], output: { itemId: 'air_rune', quantity: 1 }, baseTime: 2500 },
                    { id: 'mind_rune', name: 'Mind Altar (Mind Rune)', level: 2, xp: 5, input: [{ itemId: 'rune_essence', quantity: 1 }], output: { itemId: 'mind_rune', quantity: 1 }, baseTime: 2600 },
                    { id: 'water_rune', name: 'Water Altar (Water Rune)', level: 5, xp: 6, input: [{ itemId: 'rune_essence', quantity: 1 }], output: { itemId: 'water_rune', quantity: 1 }, baseTime: 2700 },
                    { id: 'earth_rune', name: 'Earth Altar (Earth Rune)', level: 9, xp: 6, input: [{ itemId: 'rune_essence', quantity: 1 }], output: { itemId: 'earth_rune', quantity: 1 }, baseTime: 2800 },
                    { id: 'fire_rune', name: 'Fire Altar (Fire Rune)', level: 14, xp: 7, input: [{ itemId: 'rune_essence', quantity: 1 }], output: { itemId: 'fire_rune', quantity: 1 }, baseTime: 2900 },
                    { id: 'body_rune', name: 'Body Altar (Body Rune)', level: 20, xp: 7, input: [{ itemId: 'rune_essence', quantity: 1 }], output: { itemId: 'body_rune', quantity: 1 }, baseTime: 3000 },
                    { id: 'cosmic_rune', name: 'Cosmic Altar (Cosmic Rune)', level: 27, xp: 8, input: [{ itemId: 'rune_essence', quantity: 1 }], output: { itemId: 'cosmic_rune', quantity: 1 }, baseTime: 3200 },
                    { id: 'chaos_rune', name: 'Chaos Altar (Chaos Rune)', level: 35, xp: 9, input: [{ itemId: 'rune_essence', quantity: 1 }], output: { itemId: 'chaos_rune', quantity: 1 }, baseTime: 3400 },
                    { id: 'nature_rune', name: 'Nature Altar (Nature Rune)', level: 44, xp: 10, input: [{ itemId: 'rune_essence', quantity: 1 }], output: { itemId: 'nature_rune', quantity: 1 }, baseTime: 3600 },
                    { id: 'law_rune', name: 'Law Altar (Law Rune)', level: 54, xp: 11, input: [{ itemId: 'rune_essence', quantity: 1 }], output: { itemId: 'law_rune', quantity: 1 }, baseTime: 3800 },
                    { id: 'death_rune', name: 'Death Altar (Death Rune)', level: 65, xp: 12, input: [{ itemId: 'rune_essence', quantity: 1 }], output: { itemId: 'death_rune', quantity: 1 }, baseTime: 4000 },
                    { id: 'blood_rune', name: 'Blood Altar (Blood Rune)', level: 77, xp: 13, input: [{ itemId: 'rune_essence', quantity: 1 }], output: { itemId: 'blood_rune', quantity: 1 }, baseTime: 4200 },
                ],
                alchemy: [ // from native dataset
                    { id: 'elixir_strength', name: 'Elixir of Strength', level: 1, xp: 25, input: [{ itemId: 'material_sunstone_shard', quantity: 1 }, { itemId: 'material_joyful_ember', quantity: 2 }], output: { itemId: 'item_elixir_strength', quantity: 1 }, baseTime: 5000 },
                    { id: 'scroll_fortune', name: 'Scroll of Fortune', level: 1, xp: 30, input: [{ itemId: 'material_joyful_ember', quantity: 5 }, { itemId: 'material_essence', quantity: 2 }], output: { itemId: 'item_scroll_fortune', quantity: 1 }, baseTime: 6000 },
                ]
            },
            SPELLS: [ // mirrored subset
                { id: 'spell_double_xp', name: 'Double XP', description: 'Earn double XP for a short time', requiredLevel: 1, runeCost: 1, effect: 'doubleXP', durationMs: 10 * 60 * 1000 },
                { id: 'spell_double_gold', name: 'Double Gold', description: 'Earn double gold for a short time', requiredLevel: 1, runeCost: 1, effect: 'doubleGold', durationMs: 10 * 60 * 1000 },
                { id: 'spell_golden_harvest', name: 'Golden Harvest', description: '+25% gold for 10m', requiredLevel: 7, runeCost: 3, effect: 'goldBoost', magnitude: 0.25, durationMs: 10 * 60 * 1000 },
            ],
            CHESTS: [
                { id: 'chest_common', name: 'Common Chest', description: 'Contains a few simple rewards.', cost: 250, keyItemID: null, rarity: 'common', icon: 'shippingbox', lootTable: [ {type:'currency', amount:100}, {type:'item', id:'seed_vigor', qty:1}, {type:'item', id:'material_joyful_ember', qty:2} ], rewardCount: [1,2] },
                { id: 'chest_rare', name: 'Rare Chest', description: 'Valuable materials and chance for rare seeds.', cost: 1000, keyItemID: null, rarity: 'rare', icon: 'archivebox', lootTable: [ {type:'currency', amount:500}, {type:'item', id:'seed_clarity', qty:1}, {type:'item', id:'material_sunstone_shard', qty:1}, {type:'runes', amount:1} ], rewardCount: [2,3] },
                { id: 'chest_ancient', name: 'Ancient Chest', description: 'A locked chest from a forgotten era.', cost: 0, keyItemID: 'item_ancient_key', rarity: 'epic', icon: 'treasurechest', lootTable: [ {type:'currency', amount:2000}, {type:'item', id:'seed_inspiration', qty:1}, {type:'item', id:'tree_ironwood', qty:1}, {type:'runes', amount:5} ], rewardCount: [3,4] },
            ],
            COMBAT: {
                ENEMIES: [
                    { id: 'goblin', name: 'Goblin', level: 2, hp: 30, maxHp: 30, attack: 4, defense: 1, gold: [5, 10], drops: [ {id:'copper_ore', qty:[1,2], chance:50}, {id:'tin_ore', qty:[1,2], chance:50} ], attackSpeedMs: 2000 },
                    { id: 'wolf', name: 'Wolf', level: 5, hp: 60, maxHp: 60, attack: 7, defense: 2, gold: [12, 25], drops: [ {id:'raw_shrimp', qty:[1,1], chance:30} ], attackSpeedMs: 1800 },
                    { id: 'skeleton', name: 'Skeleton', level: 10, hp: 120, maxHp: 120, attack: 12, defense: 4, gold: [30, 60], drops: [ {id:'bronze_bar', qty:[1,2], chance:35} ], attackSpeedMs: 1700 },
                    { id: 'troll', name: 'Troll', level: 20, hp: 300, maxHp: 300, attack: 20, defense: 8, gold: [80, 150], drops: [ {id:'item_ancient_key', qty:[1,1], chance:10} ], attackSpeedMs: 1600 },
                ]
            }
        };
        
        // Medieval Empire Units dataset
        const EMPIRE_UNITS = {
            gold_miner: { id: 'gold_miner', name: 'Gold Miner', emoji: 'â›ï¸', description: 'Mines gold from the mountain.', baseCost: 100, costGrowth: 1.18, goldPerSec: 1 },
            prospector: { id: 'prospector', name: 'Dwarven Prospector', emoji: 'â›ï¸âœ¨', description: 'Veteran miner with a nose for veins.', baseCost: 450, costGrowth: 1.20, goldPerSec: 3 },
            alchemist: { id: 'alchemist', name: 'Guild Alchemist', emoji: 'âš—ï¸', description: 'Brews tonics and sells them to nobles.', baseCost: 800, costGrowth: 1.22, goldPerSec: 2, runesPerSec: 0.02 },
            rune_scribe: { id: 'rune_scribe', name: 'Rune Scribe', emoji: 'ðŸ“œ', description: 'Inscribes raw essence into runes slowly.', baseCost: 1200, costGrowth: 1.25, essencePerSec: 0.1 }
        };
        GAME_DATA.UNITS = EMPIRE_UNITS;

        class Skill {
            constructor(id, name) { this.id = id; this.name = name; this.level = 1; this.currentXP = 0; this.xpToNextLevel = 100; }
            addXP(amount, game) {
                if (this.level >= 99) return;
                const intellectBonus = (this.name === META_SKILLS.INTELLECT) ? 0 : (game.state.player.meta_skills[META_SKILLS.INTELLECT].level - 1) * 0.02;
                let bonusAmount = amount * (1 + (game.state.bonfire.active ? game.state.bonfire.xpBoost : 0));
                bonusAmount *= (1 + intellectBonus) * (game.hasBuff('doubleXP') ? 2 : 1);
                this.currentXP += bonusAmount;
                while (this.currentXP >= this.xpToNextLevel) {
                    if (this.level >= 99) { this.currentXP = 0; break; }
                    this.level++; this.currentXP -= this.xpToNextLevel; this.xpToNextLevel = Math.floor(this.xpToNextLevel * 1.15);
                    game.uiManager.showFloatingText(`${this.name} Level Up!`, 'text-green-400');
                }
            }
        }

        class Mastery {
            constructor() { this.level = 0; this.currentXP = 0; this.xpToNextLevel = 50; }
            addXP(amount) { if (this.level >= 99) return; this.currentXP += amount; while (this.currentXP >= this.xpToNextLevel) { if (this.level >= 99) { this.currentXP = 0; break; } this.level++; this.currentXP -= this.xpToNextLevel; this.xpToNextLevel = Math.floor(this.xpToNextLevel * 1.08); } }
        }

        class GameState {
            constructor() {
                this.player = {
                    gold: 100,
                    runes: 5,
                    stamina: 100,
                    staminaMax: 100,
                    hp: 100,
                    hpMax: 100,
                    weapon: null,
                    skills: {},
                    meta_skills: {},
                    mastery: {},
                    activeBuffs: {}, // { effectKey: expiryTimestamp }
                };
                this.bank = {};
                this.activeAction = null; // gathering/artisan action
                this.bonfire = { active: false, expiry: 0, xpBoost: 0 };
                this.lastUpdate = Date.now();

                // Combat state
                this.combat = { inCombat: false, enemy: null, lastPlayerAttack: 0, lastEnemyAttack: 0, playerAttackSpeedMs: 1600 };

                // Clicker state
                this.clicker = { goldPerClick: 1, autoClickers: 0, autoRateMs: 1000, lastAutoTick: Date.now(), upgrades: { clickPowerLevel: 0, autoClickerLevel: 0, multiplierLevel: 0 } };

                // Empire workforce system (medieval themed)
                this.empire = {
                    units: Object.keys(GAME_DATA.UNITS).reduce((acc, id) => { acc[id] = 0; return acc; }, {}),
                    lastTick: Date.now(),
                    production: { goldPerSec: 0, runesPerSec: 0, essencePerSec: 0 },
                    buffers: { gold: 0, runes: 0, essence: 0 }
                };

                Object.keys(GAME_DATA.SKILLS).forEach(id => { this.player.skills[id] = new Skill(id, GAME_DATA.SKILLS[id].name); this.player.mastery[id] = {}; });
                Object.values(META_SKILLS).forEach(name => { this.player.meta_skills[name] = new Skill(name, name); });
                
                // Worker systems (Timber Camp for Woodcutting)
                this.workers = {
                    woodcutting: {
                        total: 0,
                        upgrades: { speedLevel: 0, yieldLevel: 0 },
                        assigned: {},
                        progress: {}
                    }
                };
                (GAME_DATA.ACTIONS.woodcutting || []).forEach(a => { this.workers.woodcutting.assigned[a.id] = 0; this.workers.woodcutting.progress[a.id] = 0; });
            }
        }

        class GameManager {
            constructor() { this.state = new GameState(); this.uiManager = new UIManager(this); this.gameLoop = null; }
            init() { this.loadGame(); this.uiManager.init(); this.gameLoop = setInterval(() => this.update(), 100); setInterval(() => this.saveGame(), 10000); window.addEventListener('beforeunload', () => this.saveGame()); }

            hasBuff(effectKey) { const exp = this.state.player.activeBuffs[effectKey]; return exp && Date.now() < exp; }

            goldMultiplier() { let mult = 1; if (this.hasBuff('doubleGold')) mult *= 2; const gh = GAME_DATA.SPELLS.find(s => s.effect === 'goldBoost'); if (this.hasBuff('goldBoost')) mult *= (1 + (gh?.magnitude || 0)); const artistry = 1 + (this.state.player.meta_skills[META_SKILLS.ARTISTRY].level - 1) * 0.02; return mult * artistry; }

            update() {
                const now = Date.now(); const delta = (now - this.state.lastUpdate); this.state.lastUpdate = now;

                // Stamina regen
                const resilienceBonus = 1 + (this.state.player.meta_skills[META_SKILLS.RESILIENCE].level - 1) * 0.05;
                const regenPerSecond = (10 / 60) * resilienceBonus;
                this.state.player.stamina = Math.min(this.state.player.staminaMax, this.state.player.stamina + (regenPerSecond * (delta / 1000)));

                // Bonfire expiry
                if (this.state.bonfire.active && now > this.state.bonfire.expiry) { this.state.bonfire.active = false; this.state.bonfire.xpBoost = 0; this.uiManager.renderView(); }

                // Gathering/Artisan action loop
                if (this.state.activeAction) {
                    const action = this.state.activeAction; action.progress += delta; const actionTime = this.calculateActionTime(action);
                    if (action.progress >= actionTime) { const loops = Math.floor(action.progress / actionTime); this.gainActionRewards(action, loops); action.progress %= actionTime; }
                    if (now >= action.endTime) { this.stopAction(); }
                }

                // Worker processing (e.g., Timber Lodge for Woodcutting)
                this.processWorkers(delta);

                // Combat loop
                if (this.state.combat.inCombat && this.state.combat.enemy) {
                    const e = this.state.combat.enemy;
                    // Player attack
                    if (now - this.state.combat.lastPlayerAttack >= this.state.combat.playerAttackSpeedMs) {
                        this.state.combat.lastPlayerAttack = now; const dmg = this.calculatePlayerDamage(e);
                        e.hp = Math.max(0, e.hp - dmg); this.uiManager.showFloatingText(`-${dmg} ${e.name}`, 'text-red-400');
                        if (e.hp <= 0) { this.handleEnemyDefeat(e); }
                    }
                    // Enemy attack
                    if (now - this.state.combat.lastEnemyAttack >= e.attackSpeedMs) {
                        this.state.combat.lastEnemyAttack = now; const enemyDmg = Math.max(0, Math.floor(e.attack - (this.state.player.meta_skills[META_SKILLS.RESILIENCE].level - 1) * 0.5));
                        this.state.player.hp = Math.max(0, this.state.player.hp - enemyDmg); this.uiManager.showFloatingText(`-${enemyDmg} HP`, 'text-yellow-400');
                        if (this.state.player.hp <= 0) { this.endCombat(false); }
                    }
                }

                // Clicker auto
                if (now - this.state.clicker.lastAutoTick >= this.state.clicker.autoRateMs) {
                    this.state.clicker.lastAutoTick = now;
                    const gps = this.state.clicker.autoClickers * this.state.clicker.goldPerClick;
                    if (gps > 0) this.addGold(gps);
                }

                // Empire production
                const empireDeltaSec = (now - this.state.empire.lastTick) / 1000;
                if (empireDeltaSec > 0.1) {
                    this.state.empire.lastTick = now;
                    const totals = this.calculateEmpireProductionPerSecond();
                    // Fractional buffers for smooth accrual
                    this.state.empire.buffers.gold += totals.goldPerSec * empireDeltaSec;
                    const goldWhole = Math.floor(this.state.empire.buffers.gold);
                    if (goldWhole > 0) { this.addGold(goldWhole); this.state.empire.buffers.gold -= goldWhole; }
                    this.state.empire.buffers.runes += (totals.runesPerSec || 0) * empireDeltaSec;
                    const runeWhole = Math.floor(this.state.empire.buffers.runes);
                    if (runeWhole > 0) { this.state.player.runes += runeWhole; this.state.empire.buffers.runes -= runeWhole; }
                    this.state.empire.buffers.essence += (totals.essencePerSec || 0) * empireDeltaSec;
                    const essWhole = Math.floor(this.state.empire.buffers.essence);
                    if (essWhole > 0) { this.addToBank('rune_essence', essWhole); this.state.empire.buffers.essence -= essWhole; }
                    this.state.empire.production = totals;
                }

                this.uiManager.updateDynamicElements();
            }

            calculateActionTime(action) {
                let time = action.baseTime;
                const stewardshipBonus = 1 - (this.state.player.meta_skills[META_SKILLS.STEWARDSHIP].level - 1) * 0.01; time *= stewardshipBonus;
                const mastery = this.getMastery(action.skillId, action.id); const masteryBonus = 1 - (mastery.level * 0.002); time *= masteryBonus;
                return time;
            }
            
            // Worker helpers
            getWorkerSpeedMultiplier(skillId, action) {
                if (skillId !== 'woodcutting') return 1;
                const speedLevel = this.state.workers.woodcutting.upgrades.speedLevel || 0;
                // 8% faster per level multiplicative
                return Math.pow(0.92, speedLevel);
            }
            getWorkerYieldMultiplier(skillId, action) {
                if (skillId !== 'woodcutting') return 1;
                const yieldLevel = this.state.workers.woodcutting.upgrades.yieldLevel || 0;
                // 10% more per level
                return 1 + (0.10 * yieldLevel);
            }
            
            processWorkers(deltaMs) {
                const wc = this.state.workers?.woodcutting; if (!wc) return;
                const actions = GAME_DATA.ACTIONS.woodcutting || [];
                for (const action of actions) {
                    const assigned = wc.assigned[action.id] || 0; if (assigned <= 0) continue;
                    const perCycleTime = this.calculateActionTime({ ...action, skillId: 'woodcutting' }) * this.getWorkerSpeedMultiplier('woodcutting', action);
                    wc.progress[action.id] += deltaMs * assigned;
                    const cycles = Math.floor(wc.progress[action.id] / perCycleTime);
                    if (cycles > 0) {
                        wc.progress[action.id] %= perCycleTime;
                        const totalQty = (action.output?.quantity || 0) * cycles * this.getWorkerYieldMultiplier('woodcutting', action);
                        if (action.output?.itemId && totalQty > 0) {
                            this.addToBank(action.output.itemId, Math.floor(totalQty));
                            // Worker XP to player skill, reduced rate (50%)
                            const xpGain = (action.xp || 0) * cycles * 0.5;
                            this.state.player.skills['woodcutting'].addXP(xpGain, this);
                        }
                        // Rare drops (each cycle independently, reduced chance)
                        if (action.rareDrop) {
                            for (let i = 0; i < cycles; i++) {
                                if (Math.random() * 100 < (action.rareDrop.chance * 0.6)) {
                                    this.addToBank(action.rareDrop.itemId, 1);
                                }
                            }
                        }
                    }
                }
            }

            getMastery(skillId, actionId) { if (!this.state.player.mastery[skillId][actionId]) { this.state.player.mastery[skillId][actionId] = new Mastery(); } return this.state.player.mastery[skillId][actionId]; }

            gainActionRewards(action, loops) {
                const skill = this.state.player.skills[action.skillId]; skill.addXP(action.xp * loops, this);
                const mastery = this.getMastery(action.skillId, action.id); mastery.addXP(action.baseTime / 1000 * loops);
                if (action.output && action.output.itemId) {
                    this.addToBank(action.output.itemId, action.output.quantity * loops);
                    this.uiManager.showFloatingText(`+${action.output.quantity * loops} ${GAME_DATA.ITEMS[action.output.itemId].name}`, 'text-white');
                }
                if (action.rareDrop) {
                    for (let i = 0; i < loops; i++) {
                        if (Math.random() * 100 < action.rareDrop.chance) {
                            this.addToBank(action.rareDrop.itemId, 1);
                            this.uiManager.showFloatingText(`+1 ${GAME_DATA.ITEMS[action.rareDrop.itemId].name}!`, 'text-yellow-400');
                        }
                    }
                }
            }

            startAction(skillId, actionId, durationMinutes) {
                if (this.state.activeAction) return;
                const cost = durationMinutes; if (this.state.player.stamina < cost) { this.uiManager.showModal('Not Enough Stamina', "<p>You don't have enough stamina to perform this action for that long.</p>"); return; }
                this.state.player.stamina -= cost;
                let actionData;
                if (GAME_DATA.ACTIONS[skillId]) actionData = GAME_DATA.ACTIONS[skillId].find(a => a.id === actionId);
                if (GAME_DATA.RECIPES[skillId]) actionData = GAME_DATA.RECIPES[skillId].find(a => a.id === actionId);
                this.state.activeAction = { ...actionData, skillId: skillId, startTime: Date.now(), endTime: Date.now() + durationMinutes * 60 * 1000, progress: 0 };
                this.uiManager.render();
            }
            stopAction() {
                if (!this.state.activeAction) return; const action = this.state.activeAction; const actionTime = this.calculateActionTime(action);
                const loops = Math.floor(action.progress / actionTime); if (loops > 0) { this.gainActionRewards(action, loops); }
                this.state.activeAction = null; this.uiManager.render();
            }

            craftItem(skillId, recipeId, quantity) {
                const recipe = GAME_DATA.RECIPES[skillId].find(r => r.id === recipeId); if (!recipe) return;
                const canCraft = recipe.input.every(inp => (this.state.bank[inp.itemId] || 0) >= inp.quantity * quantity); if (!canCraft) return;
                recipe.input.forEach(inp => this.removeFromBank(inp.itemId, inp.quantity * quantity));
                if (recipe.output && recipe.output.itemId) {
                    let totalOut = recipe.output.quantity * quantity;
                    if (skillId === 'runecrafting') {
                        const lvl = this.state.player.skills[skillId].level;
                        const mult = Math.max(1, 1 + Math.floor((lvl - recipe.level) / 11));
                        totalOut *= mult;
                    }
                    this.addToBank(recipe.output.itemId, totalOut);
                    this.uiManager.showFloatingText(`Crafted ${totalOut} ${GAME_DATA.ITEMS[recipe.output.itemId].name}`, 'text-green-400');
                }
                                const skill = this.state.player.skills[skillId]; skill.addXP(recipe.xp * quantity, this);
                // Mastery progress for artisan recipes
                const mastery = this.getMastery(skillId, recipe.id);
                mastery.addXP((recipe.baseTime || 1000) / 1000 * quantity);
                if (skillId === 'firemaking') { this.state.bonfire.active = true; this.state.bonfire.expiry = Date.now() + 2 * 60 * 60 * 1000; this.state.bonfire.xpBoost = 0.05; }
                this.uiManager.renderView();
            }

            // Economy helpers
            addGold(amount) { const final = Math.floor(amount * this.goldMultiplier()); this.state.player.gold += final; }
            spendGold(amount) { if (this.state.player.gold < amount) return false; this.state.player.gold -= amount; return true; }

            // Empire helpers
            calculateEmpireProductionPerSecond() {
                const units = this.state.empire.units || {};
                let goldPerSec = 0, runesPerSec = 0, essencePerSec = 0;
                for (const id of Object.keys(GAME_DATA.UNITS)) {
                    const data = GAME_DATA.UNITS[id];
                    const count = units[id] || 0;
                    if (count <= 0) continue;
                    if (data.goldPerSec) goldPerSec += data.goldPerSec * count;
                    if (data.runesPerSec) runesPerSec += data.runesPerSec * count;
                    if (data.essencePerSec) essencePerSec += data.essencePerSec * count;
                }
                // Gold is multiplied later via addGold; show base before buff for UI but store base here
                return { goldPerSec, runesPerSec, essencePerSec };
            }
            getEmpireUnitCost(id) {
                const data = GAME_DATA.UNITS[id];
                const owned = this.state.empire.units[id] || 0;
                return Math.floor(data.baseCost * Math.pow(data.costGrowth, owned));
            }
            hireEmpireUnit(id) {
                const cost = this.getEmpireUnitCost(id);
                if (!this.spendGold(cost)) { this.uiManager.showModal('Insufficient Gold', `<p>You need ${cost} gold to hire a ${GAME_DATA.UNITS[id].name}.</p>`); return; }
                this.state.empire.units[id] = (this.state.empire.units[id] || 0) + 1;
                this.uiManager.showFloatingText(`+1 ${GAME_DATA.UNITS[id].name}`, 'text-yellow-300');
                this.uiManager.renderView();
            }

            // Worker economy
            getHireCost(skillId) {
                if (skillId !== 'woodcutting') return Infinity;
                const base = 150;
                const owned = this.state.workers.woodcutting.total || 0;
                return Math.floor(base * Math.pow(1.35, owned));
            }
            getUpgradeCost(skillId, type) {
                if (skillId !== 'woodcutting') return Infinity;
                const base = type === 'speed' ? 250 : 300;
                const level = type === 'speed' ? (this.state.workers.woodcutting.upgrades.speedLevel || 0) : (this.state.workers.woodcutting.upgrades.yieldLevel || 0);
                return Math.floor(base * Math.pow(1.55, level));
            }
            hireWorker(skillId) {
                if (skillId !== 'woodcutting') return;
                const cost = this.getHireCost(skillId);
                if (!this.spendGold(cost)) { this.uiManager.showModal('Not Enough Gold', `<p>You need ${cost} gold to hire a worker.</p>`); return; }
                this.state.workers.woodcutting.total += 1;
                this.uiManager.showFloatingText('+1 Timberhand Hired', 'text-green-400');
                this.uiManager.renderView();
            }
            upgradeWorkers(skillId, type) {
                if (skillId !== 'woodcutting') return;
                const cost = this.getUpgradeCost(skillId, type);
                if (!this.spendGold(cost)) { this.uiManager.showModal('Not Enough Gold', `<p>You need ${cost} gold to upgrade.</p>`); return; }
                if (type === 'speed') this.state.workers.woodcutting.upgrades.speedLevel += 1;
                if (type === 'yield') this.state.workers.woodcutting.upgrades.yieldLevel += 1;
                this.uiManager.showFloatingText('Timber Lodge Upgraded!', 'text-yellow-300');
                this.uiManager.renderView();
            }

            addToBank(itemId, quantity) { this.state.bank[itemId] = (this.state.bank[itemId] || 0) + quantity; }
            removeFromBank(itemId, quantity) { this.state.bank[itemId] -= quantity; if (this.state.bank[itemId] <= 0) { delete this.state.bank[itemId]; } }

            // Rune helpers
            getRuneItemIds() { return Object.keys(GAME_DATA.ITEMS).filter(id => id.endsWith('_rune')); }
            getTotalRuneItemCount() { return this.getRuneItemIds().reduce((sum, id) => sum + (this.state.bank[id] || 0), 0); }
            consumeRuneItems(amount) {
                let remaining = amount;
                const ids = this.getRuneItemIds();
                for (const id of ids) {
                    const have = this.state.bank[id] || 0; if (have <= 0) continue;
                    const take = Math.min(have, remaining);
                    this.removeFromBank(id, take);
                    remaining -= take;
                    if (remaining <= 0) break;
                }
            }

            // Real-life task completion -> stamina + meta XP
            completeRealLifeTask(metaSkillCategory, difficulty) {
                const difficultyMultipliers = { small: 1, medium: 1.5, large: 2.5 }; const multiplier = difficultyMultipliers[difficulty];
                const staminaGained = Math.floor(10 * multiplier); this.state.player.stamina = Math.min(this.state.player.staminaMax, this.state.player.stamina + staminaGained); this.uiManager.showFloatingText(`+${staminaGained} Stamina`, 'text-green-400');
                const xpGained = Math.floor(20 * multiplier); const metaSkill = this.state.player.meta_skills[metaSkillCategory]; if (metaSkill) { metaSkill.addXP(xpGained, this); }
                this.uiManager.render();
            }

            // Spells
            castSpell(spellId) {
                const spell = GAME_DATA.SPELLS.find(s => s.id === spellId); if (!spell) return;
                const availableRunes = this.state.player.runes + this.getTotalRuneItemCount();
                if (availableRunes < spell.runeCost) { this.uiManager.showModal('Not Enough Runes', '<p>You lack the runes to cast this spell.</p>'); return; }
                // Spend generic runes first, then consume crafted rune items from bank
                const spendFromGeneric = Math.min(this.state.player.runes, spell.runeCost);
                this.state.player.runes -= spendFromGeneric;
                const remaining = spell.runeCost - spendFromGeneric;
                if (remaining > 0) this.consumeRuneItems(remaining);
                this.state.player.activeBuffs[spell.effect] = Date.now() + spell.durationMs;
                this.uiManager.showFloatingText(`${spell.name} activated!`, 'text-purple-300');
                this.uiManager.renderView();
            }

            // Chests
            buyChest(chestId) {
                const chest = GAME_DATA.CHESTS.find(c => c.id === chestId); if (!chest) return;
                if (chest.keyItemID && !(this.state.bank[chest.keyItemID] > 0)) { this.uiManager.showModal('Locked Chest', '<p>You need a special key to open this chest.</p>'); return; }
                const price = chest.cost; if (price > 0 && !this.spendGold(price)) { this.uiManager.showModal('Not Enough Gold', '<p>You cannot afford this chest.</p>'); return; }
                if (chest.keyItemID) this.removeFromBank(chest.keyItemID, 1);
                const [minR, maxR] = chest.rewardCount; const rolls = Math.floor(Math.random() * (maxR - minR + 1)) + minR;
                const rewards = [];
                for (let i = 0; i < rolls; i++) {
                    const pick = chest.lootTable[Math.floor(Math.random() * chest.lootTable.length)];
                    if (pick.type === 'currency') { const amt = pick.amount; this.addGold(amt); rewards.push(`+${amt} Gold`); }
                    if (pick.type === 'item') { const q = Array.isArray(pick.qty) ? (Math.floor(Math.random() * (pick.qty[1] - pick.qty[0] + 1)) + pick.qty[0]) : (pick.qty || 1); this.addToBank(pick.id, q); rewards.push(`+${q} ${GAME_DATA.ITEMS[pick.id]?.name || pick.id}`); }
                    if (pick.type === 'runes') { const amt = pick.amount; this.state.player.runes += amt; rewards.push(`+${amt} Runes`); }
                }
                this.uiManager.showModal('Chest Opened!', `<div class="space-y-1">${rewards.map(r => `<p>${r}</p>`).join('')}</div>`);
                this.uiManager.renderView();
            }

            // Combat
            startCombat(enemyId) {
                if (this.state.combat.inCombat) return; const e = JSON.parse(JSON.stringify(GAME_DATA.COMBAT.ENEMIES.find(x => x.id === enemyId))); if (!e) return;
                this.state.combat.inCombat = true; this.state.combat.enemy = e; this.state.player.hp = Math.min(this.state.player.hp, this.state.player.hpMax);
                this.state.combat.lastPlayerAttack = 0; this.state.combat.lastEnemyAttack = 0; this.uiManager.renderView();
            }
            endCombat(victory) {
                if (!this.state.combat.inCombat) return; if (!victory) { this.uiManager.showModal('Defeated', '<p>You were defeated. Rest to recover HP.</p>'); }
                this.state.combat.inCombat = false; this.state.combat.enemy = null; this.uiManager.renderView();
            }
            handleEnemyDefeat(enemy) {
                // Gold
                const g = Math.floor(Math.random() * (enemy.gold[1] - enemy.gold[0] + 1)) + enemy.gold[0]; this.addGold(g);
                // Drops
                (enemy.drops || []).forEach(drop => { if (Math.random() * 100 < drop.chance) { const q = Math.floor(Math.random() * (drop.qty[1] - drop.qty[0] + 1)) + drop.qty[0]; this.addToBank(drop.id, q); } });
                // XP to Strength
                this.state.player.meta_skills[META_SKILLS.STRENGTH].addXP(15 + enemy.level * 2, this);
                this.uiManager.showFloatingText(`${enemy.name} defeated!`, 'text-green-400');
                this.endCombat(true);
            }
            calculatePlayerDamage(enemy) {
                let base = 5; if (this.state.player.weapon && GAME_DATA.ITEMS[this.state.player.weapon]?.damage) base += GAME_DATA.ITEMS[this.state.player.weapon].damage;
                const strBonus = 1 + (this.state.player.meta_skills[META_SKILLS.STRENGTH].level - 1) * 0.03; const dmg = Math.max(1, Math.floor((base * strBonus) - enemy.defense * 0.5));
                return dmg;
            }
            eatFood(itemId) {
                const item = GAME_DATA.ITEMS[itemId]; if (!item || !item.heals) return; if ((this.state.bank[itemId] || 0) <= 0) return;
                this.removeFromBank(itemId, 1); this.state.player.hp = Math.min(this.state.player.hpMax, this.state.player.hp + item.heals); this.uiManager.showFloatingText(`+${item.heals} HP`, 'text-green-300'); this.uiManager.renderView();
            }
            equipWeapon(itemId) { if (!GAME_DATA.ITEMS[itemId]) return; if ((this.state.bank[itemId] || 0) <= 0) return; this.state.player.weapon = itemId; this.uiManager.renderView(); }

            saveGame() { try { localStorage.setItem('chimeraSaveData_web_v1', JSON.stringify(this.state)); } catch (e) { console.error('Failed to save game:', e); } }
            loadGame() {
                const savedData = localStorage.getItem('chimeraSaveData_web_v1');
                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        Object.assign(this.state, parsedData);
                        // Rehydrate skill objects
                        Object.keys(GAME_DATA.SKILLS).forEach(id => { const skill = new Skill(id, GAME_DATA.SKILLS[id].name); if (parsedData.player.skills?.[id]) Object.assign(skill, parsedData.player.skills[id]); this.state.player.skills[id] = skill; });
                        Object.values(META_SKILLS).forEach(name => { const skill = new Skill(name, name); if (parsedData.player.meta_skills?.[name]) Object.assign(skill, parsedData.player.meta_skills[name]); this.state.player.meta_skills[name] = skill; });
                        // Rehydrate mastery
                        Object.keys(parsedData.player.mastery || {}).forEach(skillId => {
                            if (!this.state.player.mastery[skillId]) this.state.player.mastery[skillId] = {};
                            Object.keys(parsedData.player.mastery[skillId]).forEach(actionId => { const mastery = new Mastery(); Object.assign(mastery, parsedData.player.mastery[skillId][actionId]); this.state.player.mastery[skillId][actionId] = mastery; });
                        });
                        this.state.lastUpdate = Date.now();
                        // Backfill worker system defaults if missing
                        if (!this.state.workers) { this.state.workers = { woodcutting: { total: 0, upgrades: { speedLevel: 0, yieldLevel: 0 }, assigned: {}, progress: {} } }; }
                        if (!this.state.workers.woodcutting) { this.state.workers.woodcutting = { total: 0, upgrades: { speedLevel: 0, yieldLevel: 0 }, assigned: {}, progress: {} }; }
                        (GAME_DATA.ACTIONS.woodcutting || []).forEach(a => {
                            if (typeof this.state.workers.woodcutting.assigned[a.id] !== 'number') this.state.workers.woodcutting.assigned[a.id] = 0;
                            if (typeof this.state.workers.woodcutting.progress[a.id] !== 'number') this.state.workers.woodcutting.progress[a.id] = 0;
                        });
                        // Backfill empire system defaults if missing
                        if (!this.state.empire) { this.state.empire = { units: {}, lastTick: Date.now(), production: { goldPerSec: 0, runesPerSec: 0, essencePerSec: 0 }, buffers: { gold: 0, runes: 0, essence: 0 } }; }
                        if (!this.state.empire.units) this.state.empire.units = {};
                        Object.keys(GAME_DATA.UNITS).forEach(id => { if (typeof this.state.empire.units[id] !== 'number') this.state.empire.units[id] = 0; });
                     } catch (e) { console.error('Failed to load game, starting new.', e); this.state = new GameState(); }
                 }
             }
        }

        class UIManager {
            constructor(game) {
                this.game = game; this.mainContent = document.getElementById('main-content'); this.modalBackdrop = document.getElementById('modal-backdrop'); this.modalContent = document.getElementById('modal-content'); this.floatingTextContainer = document.getElementById('floating-text-container'); this.currentView = 'dashboard';
            }
            init() { this.renderSidebar(); this.attachSidebarEventListeners(); this.render(); }
            renderSidebar() {
                const createLink = (skillId, skill) => `<a href="#" class="sidebar-link flex items-center p-3" data-view="${skillId}"><i class="fas ${skill.icon} w-6 text-center"></i><div class="flex-grow"><span>${skill.name}</span><div class="w-full xp-bar-bg rounded-full h-1.5 mt-1"><div id="sidebar-xp-${skillId}" class="xp-bar-fill h-1.5 rounded-full"></div></div></div></a>`;
                const gatheringHtml = Object.keys(GAME_DATA.SKILLS).filter(id => GAME_DATA.SKILLS[id].type === 'gathering').map(id => createLink(id, GAME_DATA.SKILLS[id])).join(''); document.getElementById('gathering-skills-nav').innerHTML = gatheringHtml;
                const artisanHtml = Object.keys(GAME_DATA.SKILLS).filter(id => GAME_DATA.SKILLS[id].type === 'artisan').map(id => createLink(id, GAME_DATA.SKILLS[id])).join(''); document.getElementById('artisan-skills-nav').innerHTML = artisanHtml;
            }
            attachSidebarEventListeners() { document.querySelectorAll('.sidebar-link').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); this.currentView = link.dataset.view; this.render(); }); }); }
            render() { this.updateSidebarActive(); this.renderView(); }

            updateDynamicElements() {
                document.getElementById('gold-display').textContent = Math.floor(this.game.state.player.gold).toLocaleString();
                const gps = this.game.state.empire?.production?.goldPerSec || 0;
                const gpsEl = document.getElementById('gps-display'); if (gpsEl) gpsEl.textContent = `(+${gps.toFixed(1)}/s)`;
                const runesEl = document.getElementById('runes-display'); if (runesEl) { const totalRunes = (this.game.state.player.runes || 0) + this.game.getTotalRuneItemCount(); runesEl.textContent = totalRunes.toLocaleString(); }
                const stamina = this.game.state.player.stamina; const staminaMax = this.game.state.player.staminaMax;
                document.getElementById('stamina-value').textContent = `${Math.floor(stamina)}/${staminaMax}`; document.getElementById('stamina-bar-fill').style.width = `${(stamina / staminaMax) * 100}%`;
                Object.keys(this.game.state.player.skills).forEach(id => { const skill = this.game.state.player.skills[id]; const xpBar = document.getElementById(`sidebar-xp-${id}`); if (xpBar) xpBar.style.width = `${(skill.currentXP / skill.xpToNextLevel) * 100}%`; });
                this.updateMasteryBar();
                // If in combat, update view footer elements
                if (this.currentView === 'combat') this.renderCombatFooter();
            }
            updateSidebarActive() { document.querySelectorAll('.sidebar-link').forEach(link => { link.classList.toggle('active', link.dataset.view === this.currentView); }); }

            updateMasteryBar() {
                const container = document.getElementById('mastery-progress-bar'); const action = this.game.state.activeAction; const inCombat = this.game.state.combat.inCombat; if (!action && !inCombat) { container.innerHTML = ''; return; }
                if (inCombat) {
                    const e = this.game.state.combat.enemy; if (!e) { container.innerHTML = ''; return; }
                    const playerHpPct = (this.game.state.player.hp / this.game.state.player.hpMax) * 100;
                    const enemyHpPct = (e.hp / e.maxHp) * 100;
                    container.innerHTML = `<div class="block p-2 h-full grid grid-cols-2 gap-2 items-center">
                        <div class="flex items-center space-x-2"><i class="fas fa-user-shield text-xl"></i><div class="w-full xp-bar-bg rounded-full h-2.5"><div class="xp-bar-fill h-2.5 rounded-full" style="width:${playerHpPct}%"></div></div><span class="text-xs font-mono">${Math.max(0, Math.floor(this.game.state.player.hp))}/${this.game.state.player.hpMax}</span></div>
                        <div class="flex items-center space-x-2"><i class="fas fa-skull text-xl"></i><div class="w-full xp-bar-bg rounded-full h-2.5"><div class="mastery-bar-fill h-2.5 rounded-full" style="width:${enemyHpPct}%"></div></div><span class="text-xs font-mono">${Math.max(0, Math.floor(e.hp))}/${e.maxHp}</span></div>
                    </div>`;
                    return;
                }
                const now = Date.now(); const timeElapsed = now - action.startTime; const totalDuration = action.endTime - action.startTime; const percentComplete = (timeElapsed / totalDuration) * 100;
                const skillData = GAME_DATA.SKILLS[action.skillId]; const actionTime = this.game.calculateActionTime(action); const xpPerHour = (3600000 / actionTime) * action.xp;
                container.innerHTML = `<div class="block p-2 h-full flex items-center space-x-4"><i class="fas ${skillData.icon} text-xl"></i><div class="flex-grow"><div class="flex justify-between text-xs"><span>${action.name}</span><span class="font-mono">${xpPerHour.toFixed(0)} XP/hr</span></div><div class="w-full xp-bar-bg rounded-full h-2.5 mt-1"><div class="xp-bar-fill h-2.5 rounded-full" style="width: ${percentComplete}%"></div></div></div><button id="stop-action-btn" class="chimera-button rounded-full w-8 h-8 flex items-center justify-center"><i class="fas fa-stop"></i></button></div>`;
                const stop = document.getElementById('stop-action-btn'); if (stop) stop.onclick = () => this.game.stopAction();
            }

            renderView() {
                let html = '';
                if (GAME_DATA.SKILLS[this.currentView]) { html = this.renderSkillView(this.currentView); }
                else {
                    switch (this.currentView) {
                        case 'dashboard': html = this.renderDashboardView(); break;
                        case 'bank': html = this.renderBankView(); break;
                        case 'meta_skills': html = this.renderMetaSkillsView(); break;
                        case 'combat': html = this.renderCombatView(); break;
                        case 'clicker': html = this.renderClickerView(); break;
                        case 'spellbook': html = this.renderSpellbookView(); break;
                        case 'shop': html = this.renderShopView(); break;
                    }
                }
                this.mainContent.innerHTML = html; this.attachViewEventListeners();
            }

            renderDashboardView() {
                const prod = this.game.state.empire.production || { goldPerSec: 0, runesPerSec: 0, essencePerSec: 0 };
                const units = this.game.state.empire.units || {};
                const unitList = Object.keys(GAME_DATA.UNITS).map(id => {
                    const u = GAME_DATA.UNITS[id];
                    const qty = units[id] || 0;
                    return `<div class="flex items-center justify-between"><span>${u.emoji} ${u.name}</span><span class="font-mono text-white">${qty}</span></div>`;
                }).join('');
                const wc = this.game.state.workers.woodcutting;
                const wcAssigned = Object.values(wc.assigned || {}).reduce((a,b)=>a+b,0);
                return `
                    <div class="block p-6 mb-4 bg-gradient-to-r from-black/40 to-black/20 border border-border-color">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-crown text-yellow-400 text-2xl"></i>
                                <div>
                                    <h1 class="text-2xl font-semibold text-white">The Sovereign's Ledger</h1>
                                    <p class="text-secondary">Command your medieval economy and rise to legend.</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button id="goto-empire" class="chimera-button px-3 py-2 rounded-md"><i class="fas fa-chess-rook"></i> Empire</button>
                                <button id="goto-woodcutting" class="chimera-button px-3 py-2 rounded-md"><i class="fas fa-tree"></i> Woodcutting</button>
                                <button id="goto-runecrafting" class="chimera-button px-3 py-2 rounded-md"><i class="fas fa-circle-nodes"></i> Runecrafting</button>
                                <button id="goto-combat" class="chimera-button px-3 py-2 rounded-md"><i class="fas fa-skull"></i> Combat</button>
                                <button id="goto-shop" class="chimera-button px-3 py-2 rounded-md"><i class="fas fa-store"></i> Shop</button>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
                        <div class="block p-4">
                            <h2 class="text-lg font-bold">Treasury</h2>
                            <p class="text-secondary">Gold on hand</p>
                            <p class="text-2xl font-mono text-yellow-300">${Math.floor(this.game.state.player.gold).toLocaleString()}</p>
                            <p class="text-xs text-green-300 mt-1">+${prod.goldPerSec.toFixed(1)}/s</p>
                        </div>
                        <div class="block p-4">
                            <h2 class="text-lg font-bold">Arcane Reserves</h2>
                            <p class="text-secondary">Runes & Essence</p>
                            <p class="text-2xl font-mono text-purple-300">${((this.game.state.player.runes||0) + this.game.getTotalRuneItemCount()).toLocaleString()}</p>
                            <p class="text-xs text-blue-300 mt-1">Runes: +${(prod.runesPerSec||0).toFixed(2)}/s â€¢ Essence: +${(prod.essencePerSec||0).toFixed(2)}/s</p>
                        </div>
                        <div class="block p-4">
                            <h2 class="text-lg font-bold">Workforce</h2>
                            <p class="text-secondary">Empire Units & Camps</p>
                            <p class="text-sm">Timberhands: <span class="font-mono text-white">${wc.total}</span> â€¢ Assigned: <span class="font-mono text-white">${wcAssigned}</span></p>
                            <div class="mt-2 space-y-1">${unitList || '<p class="text-secondary">No units hired yet.</p>'}</div>
                        </div>
                        <div class="block p-4">
                            <h2 class="text-lg font-bold">Real-life Tasks</h2>
                            <p class="text-secondary text-sm">Complete tasks to gain Stamina and level Meta Skills.</p>
                            <div id="add-task-form" class="space-y-3 mt-2">
                                <div class="grid grid-cols-2 gap-2">
                                    <select id="task-category-select" class="w-full p-2 bg-primary border border-border-color rounded-md">
                                        ${Object.entries(TASK_CATEGORIES).map(([key, value]) => `<option value="${value}">${key.charAt(0) + key.slice(1).toLowerCase()} (${value})</option>`).join('')}
                                    </select>
                                    <select id="task-difficulty-select" class="w-full p-2 bg-primary border border-border-color rounded-md">
                                        <option value="small">Small</option>
                                        <option value="medium">Medium</option>
                                        <option value="large">Large</option>
                                    </select>
                                </div>
                                <button id="add-task-btn" class="chimera-button w-full py-2 rounded-md font-bold">Complete Task & Gain Stamina</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderSkillView(skillId) {
                const skillData = GAME_DATA.SKILLS[skillId]; const playerSkill = this.game.state.player.skills[skillId]; let contentHtml = ''; let actionType = '';
                if (skillData.type === 'gathering') { actionType = 'Start'; contentHtml = GAME_DATA.ACTIONS[skillId].map(action => this.renderActionCard(skillId, action, actionType)).join(''); }
                else if (skillData.type === 'artisan') {
                    actionType = 'Craft'; if (skillId === 'firemaking') { contentHtml = this.renderFiremakingView(); }
                    else { contentHtml = GAME_DATA.RECIPES[skillId].map(recipe => this.renderActionCard(skillId, recipe, actionType)).join(''); }
                }
                const workerPanel = skillId === 'woodcutting' ? this.renderWorkerPanel() : '';
                return `<h1 class="text-2xl font-semibold text-white mb-4">${skillData.name} <span class="text-base text-secondary">(Level ${playerSkill.level})</span></h1>${workerPanel}<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">${contentHtml}</div>`;
            }

            renderActionCard(skillId, action, actionType) {
                const playerSkill = this.game.state.player.skills[skillId]; const hasLevel = playerSkill.level >= action.level; let canAfford = true;
                if (action.input) { canAfford = action.input.every(inp => (this.game.state.bank[inp.itemId] || 0) >= inp.quantity); }
                const mastery = this.game.getMastery(skillId, action.id);
                let yieldMult = 1;
                if (skillId === 'runecrafting') { yieldMult = Math.max(1, 1 + Math.floor((playerSkill.level - action.level) / 11)); }
                const inputList = action.input ? action.input.map(inp => { const has = (this.game.state.bank[inp.itemId] || 0) >= inp.quantity; return `<span class="${has ? 'text-green-400' : 'text-red-400'}">${inp.quantity}x ${GAME_DATA.ITEMS[inp.itemId].name}</span>`; }).join(', ') : '';
                const workerAssign = skillId === 'woodcutting' ? this.renderWorkerAssign(action) : '';
                return `
                    <div class="block p-4 flex flex-col justify-between ${!hasLevel ? 'opacity-50' : ''}">
                        <div>
                            <h3 class="text-lg font-bold text-white">${action.name}</h3>
                            <p class="text-secondary text-xs">Requires Level: ${action.level}</p>
                            <p class="text-secondary text-xs">XP: ${action.xp}</p>
                            ${action.input ? `<p class="text-secondary text-xs mt-1">Requires: ${inputList}</p>`: ''}
                            ${skillId === 'runecrafting' ? `<p class="text-blue-300 text-xs mt-1">Yield at Lvl ${playerSkill.level}: x${yieldMult} per essence</p>` : ''}
                            <div class="mt-2">
                                <div class="flex items-center justify-between">
                                    <span class="badge"><i class="fa-solid fa-hat-wizard"></i> Mastery Lvl ${mastery.level}</span>
                                </div>
                                <div class="w-full xp-bar-bg rounded-full h-2 my-1"><div class="mastery-bar-fill h-2 rounded-full" style="width:${(mastery.currentXP / mastery.xpToNextLevel) * 100}%"></div></div>
                                <p class="text-xs text-secondary text-right">${Math.floor(mastery.currentXP)} / ${mastery.xpToNextLevel} XP</p>
                            </div>
                            ${workerAssign}
                        </div>
                        <button class="${actionType.toLowerCase()}-action-btn chimera-button px-4 py-2 rounded-md mt-4" data-skill-id="${skillId}" data-action-id="${action.id}" ${!hasLevel || !canAfford || this.game.state.activeAction ? 'disabled' : ''}>${actionType}</button>
                    </div>
                `;
            }

            renderFiremakingView() {
                const bonfireAction = GAME_DATA.RECIPES.firemaking[0]; const bonfireCard = this.renderActionCard('firemaking', bonfireAction, 'Light');
                const bonfireStatus = this.game.state.bonfire.active ? `<p class="text-green-400">Bonfire is active! +${this.game.state.bonfire.xpBoost * 100}% Global Skill XP.</p><p class="text-xs text-secondary">Expires in: ${Math.ceil((this.game.state.bonfire.expiry - Date.now())/60000)} minutes.</p>` : '<p class="text-red-400">Bonfire is not active.</p>';
                return `<div class="col-span-1 md:col-span-2 xl:col-span-3"><div class="block p-4 mb-4"><h2 class="text-lg font-bold text-white mb-2">Bonfire Status</h2>${bonfireStatus}</div></div>${bonfireCard}`;
            }

            renderBankView() {
                let itemsHtml = Object.entries(this.game.state.bank).map(([itemId, quantity]) => { const itemData = GAME_DATA.ITEMS[itemId]; if (!itemData) return ''; return `<div class="block p-2 flex flex-col items-center justify-center text-center tooltip"><span class="tooltiptext">${itemData.name}</span><span class="text-3xl">${itemData.icon || 'â”'}</span><span class="font-mono text-white mt-1">${quantity.toLocaleString()}</span></div>`; }).join('');
                if (itemsHtml === '') { itemsHtml = `<p class="text-secondary col-span-full text-center">Your bank is empty. Gather some resources!</p>`; }
                return `<h1 class="text-2xl font-semibold text-white mb-4">Bank</h1><div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-4">${itemsHtml}</div>`;
            }

            renderMetaSkillsView() {
                const skillsHtml = Object.values(this.game.state.player.meta_skills).map(skill => {
                    let bonusText = '';
                    switch (skill.name) {
                        case META_SKILLS.STRENGTH: bonusText = `Increases combat damage.`; break;
                        case META_SKILLS.INTELLECT: bonusText = `Increases Artisan skill XP gain.`; break;
                        case META_SKILLS.STEWARDSHIP: bonusText = `- ${(skill.level - 1).toFixed(1)}% Gathering action time.`; break;
                        case META_SKILLS.RESILIENCE: bonusText = `+${((skill.level - 1) * 5).toFixed(1)}% Stamina regeneration.`; break;
                        case META_SKILLS.ARTISTRY: bonusText = `Increases Gold from all sources.`; break;
                    }
                    return `<div class="block p-4"><h3 class="text-lg font-bold text-white">${skill.name} - Level ${skill.level}</h3><div class="w-full xp-bar-bg rounded-full h-2 my-2"><div class="xp-bar-fill h-2 rounded-full" style="width:${(skill.currentXP / skill.xpToNextLevel) * 100}%"></div></div><p class="text-xs text-secondary text-right">${Math.floor(skill.currentXP)} / ${skill.xpToNextLevel} XP</p><p class="text-sm text-accent-blue mt-2">${bonusText}</p></div>`;
                }).join('');
                return `<h1 class="text-2xl font-semibold text-white mb-4">Meta Skills</h1><p class="text-secondary mb-4">These skills are leveled up by completing real-life tasks. They provide passive bonuses to your in-game actions.</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${skillsHtml}</div>`;
            }

            renderCombatView() {
                const eList = GAME_DATA.COMBAT.ENEMIES.map(e => `<button class="start-combat-btn chimera-button px-3 py-2 rounded-md" data-enemy-id="${e.id}"><i class="fas fa-skull"></i> ${e.name} (Lv ${e.level})</button>`).join(' ');
                const equipped = this.game.state.player.weapon ? GAME_DATA.ITEMS[this.game.state.player.weapon].name : 'None';
                const foodList = Object.entries(this.game.state.bank).filter(([id, q]) => GAME_DATA.ITEMS[id]?.heals).map(([id, q]) => `<button class="eat-food-btn chimera-button px-2 py-1 rounded-md" data-item-id="${id}">${GAME_DATA.ITEMS[id].name} x${q}</button>`).join(' ');
                const weapons = Object.entries(this.game.state.bank).filter(([id, q]) => GAME_DATA.ITEMS[id]?.damage).map(([id, q]) => `<button class="equip-weapon-btn chimera-button px-2 py-1 rounded-md" data-item-id="${id}">${GAME_DATA.ITEMS[id].name}</button>`).join(' ');
                const combatStatus = this.game.state.combat.inCombat && this.game.state.combat.enemy ? `<p class="text-secondary">Fighting: <span class="text-white font-bold">${this.game.state.combat.enemy.name}</span></p>` : '<p class="text-secondary">Not in combat.</p>';
                return `
                    <h1 class="text-2xl font-semibold text-white mb-4">Combat</h1>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <div class="block p-4 space-y-3">
                            <h2 class="text-lg font-bold">Enemies</h2>
                            <div class="space-x-2">${eList}</div>
                        </div>
                        <div class="block p-4 space-y-2">
                            <h2 class="text-lg font-bold">Status</h2>
                            ${combatStatus}
                            <p class="text-secondary">HP: <span class="font-mono">${Math.floor(this.game.state.player.hp)}/${this.game.state.player.hpMax}</span></p>
                            <button id="end-combat-btn" class="chimera-button px-3 py-2 rounded-md" ${this.game.state.combat.inCombat ? '' : 'disabled'}>Retreat</button>
                        </div>
                        <div class="block p-4 space-y-3">
                            <h2 class="text-lg font-bold">Equipment & Food</h2>
                            <p class="text-secondary">Weapon: <span class="text-white">${equipped}</span></p>
                            <div class="space-x-2">${weapons || '<span class="text-secondary">Craft a weapon in Smithing.</span>'}</div>
                            <div class="space-x-2">${foodList || '<span class="text-secondary">Cook food to heal.</span>'}</div>
                        </div>
                    </div>
                `;
            }
            renderCombatFooter() { /* placeholder for potential dynamic footer updates */ }

            renderClickerView() {
                const units = GAME_DATA.UNITS;
                const owned = this.game.state.empire.units;
                const prod = this.game.calculateEmpireProductionPerSecond();
                const cards = Object.keys(units).map(id => {
                    const u = units[id];
                    const qty = owned[id] || 0;
                    const cost = this.game.getEmpireUnitCost(id);
                    const lines = [];
                    if (u.goldPerSec) lines.push(`Gold: +${u.goldPerSec}/s each`);
                    if (u.runesPerSec) lines.push(`Runes: +${u.runesPerSec}/s each`);
                    if (u.essencePerSec) lines.push(`Essence: +${u.essencePerSec}/s each`);
                    return `
                        <div class="block p-4 flex flex-col justify-between">
                            <div>
                                <h3 class="text-lg font-bold">${u.emoji} ${u.name}</h3>
                                <p class="text-secondary text-xs">${u.description}</p>
                                <p class="text-secondary text-xs mt-1">${lines.join(' â€¢ ')}</p>
                                <p class="text-white text-sm mt-2">Owned: <span class="font-mono">${qty}</span></p>
                            </div>
                            <button class="hire-unit-btn chimera-button px-3 py-2 rounded-md mt-3" data-unit-id="${id}">Hire â€” Cost: ${cost} gold</button>
                        </div>
                    `;
                }).join('');
                return `
                    <h1 class="text-2xl font-semibold text-white mb-4">Empire Command</h1>
                    <div class="block p-4 mb-4">
                        <h2 class="text-lg font-bold">Production</h2>
                        <p class="text-secondary text-sm">Gold: <span class="text-white">+${prod.goldPerSec.toFixed(1)}/s</span> â€¢ Runes: <span class="text-white">+${(prod.runesPerSec||0).toFixed(2)}/s</span> â€¢ Essence: <span class="text-white">+${(prod.essencePerSec||0).toFixed(2)}/s</span></p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${cards}</div>
                `;
            }

            renderSpellbookView() {
                const buffs = this.game.state.player.activeBuffs || {};
                const cards = GAME_DATA.SPELLS.map(s => {
                    const active = buffs[s.effect] && Date.now() < buffs[s.effect];
                    const remaining = active ? Math.ceil((buffs[s.effect] - Date.now()) / 1000) : 0;
                    return `
                        <div class="block p-4 flex flex-col justify-between ${active ? 'ring-1 ring-purple-400' : ''}">
                            <div>
                                <h3 class="text-lg font-bold">${s.name}</h3>
                                <p class="text-secondary text-xs">${s.description}</p>
                                <p class="text-secondary text-xs">Rune Cost: ${s.runeCost}</p>
                                ${active ? `<p class="text-purple-300 text-xs">Active â€¢ ${remaining}s left</p>` : ''}
                            </div>
                            <button class="cast-spell-btn chimera-button px-3 py-2 rounded-md mt-3" data-spell-id="${s.id}" ${active ? 'disabled' : ''}>Cast</button>
                        </div>
                    `;
                }).join('');
                return `<h1 class="text-2xl font-semibold text-white mb-4">Spellbook</h1><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${cards}</div>`;
            }

            renderShopView() {
                const chestCards = GAME_DATA.CHESTS.map(c => `
                    <div class="block p-4 flex flex-col justify-between">
                        <div>
                            <h3 class="text-lg font-bold">${c.name}</h3>
                            <p class="text-secondary text-xs">${c.description}</p>
                            <p class="text-secondary text-xs">${c.keyItemID ? 'Requires Key' : 'Cost: ' + c.cost + ' gold'}</p>
                        </div>
                        <button class="buy-chest-btn chimera-button px-3 py-2 rounded-md mt-3" data-chest-id="${c.id}">${c.keyItemID ? 'Open' : 'Buy & Open'}</button>
                    </div>
                `).join('');
                return `<h1 class="text-2xl font-semibold text-white mb-4">Shop</h1><div class="grid grid-cols-1 md:grid-cols-3 gap-4">${chestCards}</div>`;
            }

            attachViewEventListeners() {
                const addTaskBtn = document.getElementById('add-task-btn'); if (addTaskBtn) { addTaskBtn.addEventListener('click', () => { const category = document.getElementById('task-category-select').value; const difficulty = document.getElementById('task-difficulty-select').value; this.game.completeRealLifeTask(category, difficulty); }); }
                const ge = document.getElementById('goto-empire'); if (ge) ge.addEventListener('click', () => { this.currentView = 'clicker'; this.render(); });
                const gw = document.getElementById('goto-woodcutting'); if (gw) gw.addEventListener('click', () => { this.currentView = 'woodcutting'; this.render(); });
                const gr = document.getElementById('goto-runecrafting'); if (gr) gr.addEventListener('click', () => { this.currentView = 'runecrafting'; this.render(); });
                const gc = document.getElementById('goto-combat'); if (gc) gc.addEventListener('click', () => { this.currentView = 'combat'; this.render(); });
                const gs = document.getElementById('goto-shop'); if (gs) gs.addEventListener('click', () => { this.currentView = 'shop'; this.render(); });
                document.querySelectorAll('.start-action-btn').forEach(btn => { btn.addEventListener('click', () => { const duration = parseInt(prompt('Enter duration in minutes:', '15'), 10); if (isNaN(duration) || duration <= 0) return; this.game.startAction(btn.dataset.skillId, btn.dataset.actionId, duration); }); });
                document.querySelectorAll('.craft-action-btn, .light-action-btn').forEach(btn => { btn.addEventListener('click', () => {
                    const s = btn.dataset.skillId; const a = btn.dataset.actionId;
                    if (s === 'runecrafting') {
                        const recipe = (GAME_DATA.RECIPES[s] || []).find(r => r.id === a);
                        const essenceId = (recipe && recipe.input && recipe.input[0]) ? recipe.input[0].itemId : 'rune_essence';
                        const essencePer = (recipe && recipe.input && recipe.input[0]) ? recipe.input[0].quantity : 1;
                        const haveEss = this.game.state.bank[essenceId] || 0;
                        const maxQty = Math.floor(haveEss / essencePer);
                        if (maxQty <= 0) return;
                        const qty = parseInt(prompt(`How many essences to craft? (Max ${maxQty})`, `${Math.min(25, maxQty)}`), 10);
                        if (isNaN(qty) || qty <= 0) return;
                        this.game.craftItem(s, a, Math.min(qty, maxQty));
                    } else {
                        this.game.craftItem(s, a, 1);
                    }
                }); });

                // Combat
                document.querySelectorAll('.start-combat-btn').forEach(btn => { btn.addEventListener('click', () => this.game.startCombat(btn.dataset.enemyId)); });
                const endBtn = document.getElementById('end-combat-btn'); if (endBtn) endBtn.addEventListener('click', () => this.game.endCombat(false));
                document.querySelectorAll('.eat-food-btn').forEach(btn => { btn.addEventListener('click', () => this.game.eatFood(btn.dataset.itemId)); });
                document.querySelectorAll('.equip-weapon-btn').forEach(btn => { btn.addEventListener('click', () => this.game.equipWeapon(btn.dataset.itemId)); });

                // Empire hiring events
                document.querySelectorAll('.hire-unit-btn').forEach(btn => { btn.addEventListener('click', () => this.game.hireEmpireUnit(btn.dataset.unitId)); });

                // Spells
                document.querySelectorAll('.cast-spell-btn').forEach(btn => { btn.addEventListener('click', () => this.game.castSpell(btn.dataset.spellId)); });
                // Shop
                document.querySelectorAll('.buy-chest-btn').forEach(btn => { btn.addEventListener('click', () => this.game.buyChest(btn.dataset.chestId)); });

                // Workers - Woodcutting
                const hire = document.getElementById('hire-wood-worker'); if (hire) hire.addEventListener('click', () => this.game.hireWorker('woodcutting'));
                const upS = document.getElementById('upgrade-wood-speed'); if (upS) upS.addEventListener('click', () => this.game.upgradeWorkers('woodcutting', 'speed'));
                const upY = document.getElementById('upgrade-wood-yield'); if (upY) upY.addEventListener('click', () => this.game.upgradeWorkers('woodcutting', 'yield'));
                document.querySelectorAll('.assign-worker-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.dataset.actionId; const dir = btn.dataset.dir;
                        const wc = this.game.state.workers.woodcutting;
                        const sumAssigned = Object.values(wc.assigned).reduce((a,b)=>a+b,0);
                        if (dir === '+1') {
                            if (sumAssigned < wc.total) { wc.assigned[id] = (wc.assigned[id] || 0) + 1; this.renderView(); }
                        } else {
                            if ((wc.assigned[id] || 0) > 0) { wc.assigned[id] -= 1; this.renderView(); }
                        }
                    });
                });
            }

            showModal(title, content) {
                const html = `<h3 class=\"text-xl font-bold text-white\">${title}</h3><div class=\"text-secondary my-4\">${content}</div><div class=\"text-right mt-6\"><button class=\"close-btn chimera-button px-4 py-2 rounded-md\">Close</button></div>`;
                this.modalContent.innerHTML = html; this.modalContent.querySelector('.close-btn').addEventListener('click', () => this.hideModal()); this.modalBackdrop.classList.remove('hidden');
            }
            hideModal() { this.modalBackdrop.classList.add('hidden'); }

            showFloatingText(text, className, options = {}) {
                if (!this._fly) { this._fly = { nextLane: 0, maxLanes: 12, laneHeight: 28 }; }
                const detectType = (t, cls = '') => {
                    const lower = (t || '').toLowerCase(); const c = cls || '';
                    if (lower.includes('level up')) return 'fly-level';
                    if (lower.includes('activated')) return 'fly-buff';
                    if (lower.includes('stamina') || lower.includes('hp') || c.includes('green')) return 'fly-heal';
                    if (lower.startsWith('-') || c.includes('red')) return 'fly-damage';
                    if (lower.includes('crafted') || lower.includes('+1 ') || c.includes('yellow')) return 'fly-loot';
                    if (lower.includes('xp')) return 'fly-xp';
                    return '';
                };
                const typeClass = detectType(text, className);

                const floatText = document.createElement('div');
                floatText.className = `floating-text ${typeClass} ${className || ''}`.trim();
                floatText.textContent = text;

                const gameRect = this.floatingTextContainer.getBoundingClientRect();
                const baseX = gameRect.width / 2;
                const baseY = gameRect.height / 3;

                const lane = this._fly.nextLane; this._fly.nextLane = (this._fly.nextLane + 1) % this._fly.maxLanes;
                const jitterX = (Math.random() - 0.5) * 80; // -40..+40
                const y = baseY - lane * this._fly.laneHeight;

                floatText.style.left = `${baseX + jitterX}px`;
                floatText.style.top = `${y}px`;

                this.floatingTextContainer.appendChild(floatText);
                const duration = typeClass === 'fly-crit' || typeClass === 'fly-level' ? 1900 : (typeClass === 'fly-loot' ? 1800 : 1600);
                setTimeout(() => floatText.remove(), duration);
            }

            renderWorkerPanel() {
                const wc = this.game.state.workers.woodcutting;
                const hireCost = this.game.getHireCost('woodcutting');
                const speedCost = this.game.getUpgradeCost('woodcutting', 'speed');
                const yieldCost = this.game.getUpgradeCost('woodcutting', 'yield');
                const speedLvl = wc.upgrades.speedLevel;
                const yieldLvl = wc.upgrades.yieldLevel;
                return `
                    <div class="block p-4 mb-4 border border-woodcutting">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <div>
                                <h2 class="text-lg font-bold">Timber Lodge</h2>
                                <p class="text-secondary text-sm">Timberhands harvest trees in the background. Assign them to specific tree types.</p>
                                <p class="text-white text-sm mt-1">Workers: <span class="font-bold">${wc.total}</span></p>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2">
                                <button id="hire-wood-worker" class="chimera-button px-3 py-2 rounded-md">Hire Timberhand â€” Cost: ${hireCost} gold</button>
                                <button id="upgrade-wood-speed" class="chimera-button px-3 py-2 rounded-md">Upgrade Axes (Speed L${speedLvl}) â€” Cost: ${speedCost} gold</button>
                                <button id="upgrade-wood-yield" class="chimera-button px-3 py-2 rounded-md">Lumber Sleds (Yield L${yieldLvl}) â€” Cost: ${yieldCost} gold</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderWorkerAssign(action) {
                const wc = this.game.state.workers.woodcutting; const assigned = wc.assigned[action.id] || 0;
                const total = wc.total; const sumAssigned = Object.values(wc.assigned).reduce((a,b)=>a+b,0);
                const free = Math.max(0, total - sumAssigned);
                const speedMult = this.game.getWorkerSpeedMultiplier('woodcutting', action);
                const yieldMult = this.game.getWorkerYieldMultiplier('woodcutting', action);
                return `
                    <div class="mt-3 p-2 rounded-md bg-black/30 border border-border-color">
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-secondary">Timberhands Assigned: <span class="text-white font-mono">${assigned}</span> / Free: <span class="text-white font-mono">${free}</span></span>
                            <div class="space-x-1">
                                <button class="assign-worker-btn chimera-button px-2 py-1 rounded" data-action-id="${action.id}" data-dir="-1">-</button>
                                <button class="assign-worker-btn chimera-button px-2 py-1 rounded" data-action-id="${action.id}" data-dir="+1">+</button>
                            </div>
                        </div>
                        <p class="text-[11px] text-secondary mt-1">Eff: x${yieldMult.toFixed(2)} yield, ${Math.round(100 - speedMult*100)}% faster</p>
                    </div>
                `;
            }
        }

        const game = new GameManager(); game.init(); window.chimeraGame = game;
    });
    </script>
</body>
</html>